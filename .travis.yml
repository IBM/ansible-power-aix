---
arch: amd64
os: linux
dist: focal
language: python
python:
  - "3.8"

jobs:
  allow_failures:
    - name: "sanity-test"
    - name: "porting-test"
    - name: "compile-test"
    - name: "module-linting-test"
    - name: "unit-test"
    - name: "gen-doc-files"

  include:
  ########################################################################
  # sanity test
  # - makes sure that the collection passes the ansible sanity tests
  ########################################################################
    - name: "sanity-test"
      env: 
        - NAME="sanity-test"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make install-sanity-test-requirements
        - make sanity-test

    - name: "sanity-test"
      env: 
        - NAME="sanity-test"
        - ANSIBLE_VERSION="3"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make install-sanity-test-requirements
        - make sanity-test

    - name: "sanity-test"
      env:
        - NAME="sanity-test"
        - ANSIBLE_VERSION="4"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make install-sanity-test-requirements
        - make sanity-test

    - name: "sanity-test"
      env:
        - NAME="sanity-test"
        - ANSIBLE_VERSION="devel"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible-devel-branch
        - make install-sanity-test-requirements
        - make sanity-test

  ########################################################################
  # porting test
  # - makes sure that the collection is properly ported for python3
  ########################################################################
    - name: "porting-test"
      env:
        - NAME="porting-test"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - python -m pip install --upgrade pip
        - python -m pip install pylint==2.10.*
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make porting

  ########################################################################
  # compile test
  # - makes sure that the collection has compatible syntax
  # with python version 2.7, 3.6, 3.7, and 3.8
  ########################################################################
    - name: "compile-test"
      language: python
      python:
        - "2.7"
      env:
        - NAME="compile-test"
        - PYTHON_VERSION="2.7"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make compile PYTHON_VERSION=${PYTHON_VERSION}

    - name: "compile-test"
      language: python
      python:
        - "3.6"
      env:
        - NAME="compile-test"
        - PYTHON_VERSION="3.6"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make compile PYTHON_VERSION=${PYTHON_VERSION}

    - name: "compile-test"
      language: python
      python:
        - "3.7"
      env:
        - NAME="compile-test"
        - PYTHON_VERSION="3.7"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make compile PYTHON_VERSION=${PYTHON_VERSION}

    - name: "compile-test"
      language: python
      python:
        - "3.8"
      env:
        - NAME="compile-test"
        - PYTHON_VERSION="3.8"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make compile PYTHON_VERSION=${PYTHON_VERSION}

  ########################################################################
  # module linting test
  # - makes sure that the collection conforms with PEP8 coding style
  # standards
  ########################################################################
    - name: "module-linting-test"
      env: 
        - NAME="module-linting-test"
        - ANSIBLE_VERSION="2.9"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=${ANSIBLE_VERSION}
        - make install-sanity-test-requirements
        - make module-lint

  ########################################################################
  # unit test
  # - run unit tests for the modules
  ########################################################################
    - name: "unit-test"
      env: 
        - NAME="unit-test"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=2.9
        - make install-unit-test-requirements
        - make unit-test

  ########################################################################
  # generate doc files
  ########################################################################
    - name: "gen-doc-files"
      env: 
        - NAME="gen-doc-files"
        - ANSIBLE_COLLECTION_DIR=ansible_collections/ibm/power_aix/
      script:
        - git clone --branch ${TRAVIS_BRANCH} git@github.ibm.com:ansible-power-aix/development.git ${ANSIBLE_COLLECTION_DIR}
        - cd ${ANSIBLE_COLLECTION_DIR}
        - export ANSIBLE_COLLECTIONS_PATHS=$(pwd)
        - make install-ansible ANSIBLE_VERSION=2.9
        - python -m pip install ansible-doc-extractor
        - python -m pip install sphinx
        - python -m pip install sphinx_rtd_theme
        - bash devops/bin/gen_doc.sh

# push the generate documentation using Github Pages
deploy:
  provider: pages
  strategy: git
  skip_cleanup: true
  token: $GIHUB_API_KEY
  local_dir: docs/build
  keep_history: true
  on:
    branch: dev-collection

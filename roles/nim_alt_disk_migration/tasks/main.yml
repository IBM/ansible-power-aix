# Copyright (c) IBM Corporation 2020
---
############################################################
############################################################

- name: "Fail if a NIM client LPAR is not specified"
  fail:
    msg: "NIM client LPAR to be migrated is not specified"
  when: nim_client is not defined
- debug: msg="{{ nim_client }} specified to be migrated"

############################################################
############################################################

- name: "Fetch client oslevel"
  include_tasks: "get_oslevel.yml"
  when: nim_client is defined

############################################################
############################################################

- name: "Fail if a physical volume is not specified
        for alternate disk creation"
  fail:
    msg: "target_disk not specified"
  when: target_disk is not defined
- debug: msg="{{ target_disk }} of {{ nim_client }} will be used to
              create an alternate disk copy"

############################################################
############################################################

- name: "Verify that the specfied physical volume availability"
  include_tasks: "validate_pv.yml"
  when: target_disk is defined

############################################################
############################################################

- name: "Fail if a NIM LPP resource is not specified"
  fail:
    msg: "NIM LPP resource not specified"
  when: lpp_source is not defined
- debug: msg="LPP resource {{ lpp_source }} specified for migration"

############################################################
############################################################

############################################################
# NOTE: specifying SPOT resource is optional, if not given
# then NIM master will generate corresponding SPOT resource
# from the specified LPP resource.
############################################################

- name: "Create SPOT resource if not specified"
  include_tasks: "create_spot.yml"
  when: spot is not defined
- debug: msg="SPOT resource {{ spot }} specified for migration"

############################################################
############################################################

- name: "Verify that the client LPAR is at least a Power8 machine"
  include_tasks: "validate_min_power_level.yml"
- debug: msg="{{ nim_client }} has at least a PowerPC_Power8 processor"

############################################################
# TODO: make sure to setup rsh (remote command exection) from
# NIM master to specified NIM client
# create an entry in each others hostname (NIM client/master)
# /.rhosts  file to make the rsh command useable.
# ADDITIONAL RESEARCH:
# - do you actually need to do this step to make nimadm
# work?
############################################################

############################################################
# TODO: make sure the SPOT resource matches the NIM master's
# level
# 0505-204 nimadm: SPOT dflt_spot does not have bos.alt_disk_install.rte installed.",
# "0505-205 nimadm: The level of bos.alt_disk_install.rte installed in SPOT",
# "dflt_spot (0.0.0.0) does not match the NIM master's level (7.3.0.0)."]
# HOW TO FIX:
# http://aix-skills.blogspot.com/2015/11/spot-does-not-match-nim-masters-level.html
############################################################

############################################################
# TODO: create a plugin to support nimadm (NIM alternate disk migration)
#
# TODO: fix the following issue below,
# INVESTIGATE: successfully creates an altinst_rootvg on NIM client
# however Ansible output give the following error:
# TASK [ibm.power_aix.alt_disk_migration : Migrate to alternate disk] *********************************
# fatal: [x.x.x.x]: UNREACHABLE! =>
#     {
#       "changed": false,
#       "msg": "Failed to connect to the host via ssh: Shared connection to x.x.x.x closed.",
#       "unreachable": true
#     }
# x.x.x.x is the NIM master
# why would it be unreachable when the shell cmd nimadm it was reachable and the task was
# running
#
# SOLUTION
# - asynchronous action and polling
#   large timeout: nimadm takes 2-3 hours to complete
#   migration in normal case. The timeout (async)
#   is set up to 4 hours, which is high enough to not
#   cause "check on it later" task to fail
#   or no longer exist error.
#
#   poll = 0 to start the task and immediately move on
#   to the next one without waiting a result. The nimadm
#   task will run until it either complete, fail or timeout.
############################################################

- name: "Migrate to alternate disk"
  shell: "nimadm -c {{ nim_client }} -l {{ lpp_source }} -s {{ spot }} -d {{ target_disk }} -Y"
  register: results
  async: "{{ wait_nimadm_timeout_secs }}"
  poll: 0
- debug: #var=results
    msg: "timeout = {{ wait_nimadm_timeout_secs }}"

############################################################
#
# check on async task later
# perform a task to check on nimadm task via its registered
# job ID
############################################################

- name: "Check on an async task"
  async_status:
    jid: "{{ results.ansible_job_id }}"
  register: async_poll_results
  until: async_poll_results.finished
  retries: "{{ retry_chk_nimadm_comp }}"
  delay: "{{ interval }}"
- debug: #var=async_poll_results
    msg: "retry = {{ retry_chk_nimadm_comp }}"

############################################################

- block:
    - name: "Rebooting {{ nim_client }}"
      ibm.power_aix.nim:
        action: reboot
        targets: "{{ nim_client }}"
      register: results
    - debug: var=results
  when: reboot_client

- debug:
    msg: >
      'altinst_rootvg' successfully created in '{{ nim_client }}'.
      Reboot '{{ nim_client }}' to boot into the alterate disk.
  when: not reboot_client

############################################################
############################################################

- debug: msg="MIGRATION COMPLETE!!!"
